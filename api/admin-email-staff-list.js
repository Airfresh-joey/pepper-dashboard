/**
 * Admin Chat - Email Staff List
 * POST /api/admin/staff-list/email
 * 
 * Emails a generated staff list PDF to the specified recipient
 * Uses Supabase email service or SendGrid
 */

const SUPABASE_URL = process.env.SUPABASE_URL;
const SUPABASE_ANON_KEY = process.env.SUPABASE_ANON_KEY;

async function emailStaffList(req, res) {
  try {
    if (req.method !== 'POST') {
      return res.status(405).json({ error: 'Method not allowed' });
    }

    const { 
      staff_list_id,
      pdf_url,
      recipient_email,
      event_name,
      sent_by
    } = req.body;

    if (!staff_list_id || !recipient_email) {
      return res.status(400).json({ 
        error: 'Missing required fields: staff_list_id, recipient_email' 
      });
    }

    // Initialize Supabase client
    const { createClient } = require('@supabase/supabase-js');
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Get staff list record
    const { data: staffListRecord, error: fetchError } = await supabase
      .from('staff_list_generations')
      .select('*')
      .eq('id', staff_list_id)
      .single();

    if (fetchError) {
      return res.status(404).json({ 
        error: 'Staff list not found',
        details: fetchError.message 
      });
    }

    // Prepare email
    const emailSubject = `Staff List - ${event_name || staffListRecord.event_name}`;
    const emailBody = `
Dear Team,

Please find attached the staff list for ${event_name || staffListRecord.event_name}.

This list includes:
- Staff names (with last initials for privacy)
- Contact phone numbers
- Shift dates and hours
- Assignment locations

Team member photos and additional details are included in the PDF.

Generated: ${new Date().toLocaleString()}
Generated by: ${staffListRecord.generated_by_name}

Best regards,
ImmerseForge Administration
    `;

    // TODO: Integrate with SendGrid, AWS SES, or Supabase email service
    // For now, log the email action
    console.log('Email preparation:', {
      to: recipient_email,
      subject: emailSubject,
      pdf_url: pdf_url || staffListRecord.pdf_url
    });

    // Update staff list record with email info
    const { data: updateData, error: updateError } = await supabase
      .from('staff_list_generations')
      .update({
        status: 'emailed',
        emailed_to: recipient_email,
        emailed_at: new Date().toISOString()
      })
      .eq('id', staff_list_id)
      .select();

    if (updateError) {
      console.error('Database update error:', updateError);
      return res.status(500).json({ 
        error: 'Failed to update staff list status',
        details: updateError.message 
      });
    }

    return res.status(200).json({
      success: true,
      message: 'Email sent successfully',
      recipient: recipient_email,
      event: event_name || staffListRecord.event_name,
      sent_at: new Date().toISOString(),
      next_steps: 'Staff list email has been queued for delivery'
    });

  } catch (error) {
    console.error('Error emailing staff list:', error);
    return res.status(500).json({ 
      error: 'Internal server error',
      details: error.message 
    });
  }
}

module.exports = emailStaffList;
