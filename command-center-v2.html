<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Center</title>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-dark: #1a1a1a;
            --bg-card: #242424;
            --bg-hover: #2a2a2a;
            --bg-sidebar: #141414;
            --text-primary: #ffffff;
            --text-secondary: #888;
            --border-color: #333;
            --green: #22c55e;
            --blue: #3b82f6;
            --red: #ef4444;
            --yellow: #f59e0b;
            --purple: #8b5cf6;
        }

        /* Light Mode */
        .light-mode {
            --bg-dark: #f5f5f5;
            --bg-card: #ffffff;
            --bg-hover: #f0f0f0;
            --bg-sidebar: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #666;
            --border-color: #e0e0e0;
        }

        .light-mode .sidebar { background: var(--bg-sidebar); }
        .light-mode .task-card { background: var(--bg-card); border-color: var(--border-color); }
        .light-mode .modal-content { background: var(--bg-card); }
        .light-mode .form-input { background: var(--bg-dark); }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .loading-overlay.hidden { display: none; }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Sync Status */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            padding: 4px 10px;
            border-radius: 12px;
            background: var(--bg-card);
        }
        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--green);
        }
        .sync-dot.syncing { background: var(--yellow); animation: pulse 1s infinite; }
        .sync-dot.error { background: var(--red); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Theme Toggle */
        .theme-toggle {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.2s;
        }
        .theme-toggle:hover { background: var(--bg-hover); border-color: var(--purple); }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: fixed;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-logo {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--purple), var(--blue));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .sidebar-title { font-weight: 600; font-size: 1.1rem; }

        .sidebar-section { padding: 20px; }
        .sidebar-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .sidebar-nav { list-style: none; }
        .sidebar-nav li { margin-bottom: 4px; }
        .sidebar-nav a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .sidebar-nav a:hover, .sidebar-nav a.active {
            background: var(--bg-card);
            color: var(--text-primary);
        }
        .sidebar-nav a.active {
            background: rgba(139, 92, 246, 0.2);
            color: var(--purple);
        }

        .project-list { flex: 1; overflow-y: auto; padding: 0 20px; }

        .project-link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.2s;
            margin-bottom: 4px;
            cursor: pointer;
        }
        .project-link:hover, .project-link.active {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .project-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            margin-top: auto;
        }

        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--purple);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.8rem;
        }
        .user-name { font-size: 0.9rem; }
        .user-email { font-size: 0.75rem; color: var(--text-secondary); }

        /* Main Content */
        .main {
            flex: 1;
            margin-left: 240px;
            padding: 30px;
            overflow-y: auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-title { display: flex; align-items: center; gap: 15px; }
        .page-title h1 { font-size: 1.5rem; font-weight: 600; }
        .page-title .updated { font-size: 0.85rem; color: var(--text-secondary); }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary { background: var(--purple); color: white; }
        .btn-primary:hover { background: #7c3aed; }
        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        .btn-secondary:hover { background: var(--bg-hover); }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .stat-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .stat-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }
        .stat-icon.green { background: rgba(34, 197, 94, 0.2); color: var(--green); }
        .stat-icon.blue { background: rgba(59, 130, 246, 0.2); color: var(--blue); }
        .stat-icon.red { background: rgba(239, 68, 68, 0.2); color: var(--red); }
        .stat-icon.purple { background: rgba(139, 92, 246, 0.2); color: var(--purple); }

        .stat-label { font-size: 0.85rem; color: var(--text-secondary); }
        .stat-value { font-size: 2rem; font-weight: 600; }

        /* View Tabs */
        .view-tabs { display: flex; gap: 10px; margin-bottom: 30px; }
        .view-tab {
            padding: 10px 20px;
            border-radius: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .view-tab:hover { background: var(--bg-hover); color: var(--text-primary); }
        .view-tab.active { background: var(--bg-hover); color: var(--text-primary); border-color: var(--purple); }

        /* Projects Grid */
        .section-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .project-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
        }
        .project-card:hover { border-color: var(--purple); transform: translateY(-2px); }

        .project-card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .project-card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
        }
        .project-card-info { flex: 1; }
        .project-card-name { font-weight: 600; font-size: 1rem; }
        .project-card-tasks { font-size: 0.85rem; color: var(--text-secondary); }
        .project-card-percent { font-size: 1.25rem; font-weight: 600; }

        .project-progress {
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            overflow: hidden;
        }
        .project-progress-bar { height: 100%; border-radius: 2px; transition: width 0.3s; }

        /* Kanban View */
        .kanban-container { display: none; }
        .kanban-container.active { display: block; }

        .kanban-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
        }
        .back-btn:hover { color: var(--text-primary); }

        .kanban-project-info { display: flex; align-items: center; gap: 15px; }
        .kanban-project-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.2rem;
        }
        .kanban-project-name { font-size: 1.5rem; font-weight: 600; }

        .kanban-tabs {
            display: flex;
            gap: 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        .kanban-tab {
            padding: 12px 0;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .kanban-tab:hover { color: var(--text-primary); }
        .kanban-tab.active { color: var(--text-primary); border-bottom-color: var(--text-primary); }

        .kanban-filters { display: flex; gap: 10px; margin-bottom: 20px; }
        .filter-chip {
            padding: 6px 14px;
            border-radius: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-chip:hover { color: var(--text-primary); }
        .filter-chip.active { background: var(--text-primary); color: var(--bg-dark); }

        .kanban-board {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            min-height: 500px;
        }

        .kanban-column {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border-color);
        }

        .column-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        .column-dot { width: 8px; height: 8px; border-radius: 50%; }
        .column-title { font-weight: 500; font-size: 0.9rem; text-transform: uppercase; }
        .column-count { color: var(--text-secondary); font-size: 0.85rem; }

        .task-list { display: flex; flex-direction: column; gap: 10px; min-height: 300px; }

        .task-card {
            background: var(--bg-dark);
            border-radius: 8px;
            padding: 14px;
            border: 1px solid var(--border-color);
            cursor: grab;
            transition: all 0.2s;
        }
        .task-card:hover { border-color: var(--purple); }
        .task-card.dragging { opacity: 0.5; cursor: grabbing; }

        .task-title { font-size: 0.9rem; margin-bottom: 10px; }
        .task-meta { display: flex; gap: 8px; flex-wrap: wrap; }
        .task-tag { padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; }
        .task-tag.due { background: rgba(239, 68, 68, 0.2); color: var(--red); }
        .task-tag.assignee { background: rgba(59, 130, 246, 0.2); color: var(--blue); }

        .add-task-btn {
            width: 100%;
            padding: 10px;
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .add-task-btn:hover { border-color: var(--purple); color: var(--text-primary); }

        .overview-container { display: block; }
        .overview-container.hidden { display: none; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal.active { display: flex; }

        .modal-content {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 480px;
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .modal-title { font-size: 1.25rem; font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 0.9rem; margin-bottom: 8px; }
        .form-input {
            width: 100%;
            padding: 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }
        .form-input:focus { outline: none; border-color: var(--purple); }
        .form-textarea { min-height: 100px; resize: vertical; font-family: inherit; }

        .color-options { display: flex; gap: 10px; flex-wrap: wrap; }
        .color-option {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .color-option:hover { transform: scale(1.1); }
        .color-option.selected { border-color: white; }

        .status-options { display: flex; flex-wrap: wrap; gap: 8px; }
        .status-option {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .status-option:hover { color: var(--text-primary); }
        .status-option.selected { background: rgba(34, 197, 94, 0.2); color: var(--green); border-color: var(--green); }

        .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; }

        /* Responsive */
        @media (max-width: 1200px) {
            .projects-grid { grid-template-columns: repeat(2, 1fr); }
            .kanban-board { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 900px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .kanban-board { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main { margin-left: 0; }
            .projects-grid { grid-template-columns: 1fr; }
            .kanban-board { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading">
        <div class="loading-spinner"></div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">P</div>
            <span class="sidebar-title">Pepper</span>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-label">Admin</div>
            <ul class="sidebar-nav">
                <li><a href="#" class="active" onclick="showOverview()"><span>üìä</span> Overview</a></li>
                <li><a href="#" onclick="showAllTasks()"><span>üìã</span> All Tasks</a></li>
            </ul>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-label">Projects</div>
        </div>

        <div class="project-list" id="sidebar-projects"></div>

        <div class="sidebar-section">
            <div class="sidebar-label">AI Products</div>
            <ul class="sidebar-nav">
                <li><a href="live/bloom.html" target="_blank"><span>üå∏</span> BLOOM Proposals</a></li>
                <li><a href="live/nectar.html" target="_blank"><span>üçØ</span> NECTAR CRM</a></li>
            </ul>
        </div>

        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar">JK</div>
                <div>
                    <div class="user-name">Joey Kercher</div>
                    <div class="user-email">joey@airfresh.com</div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main">
        <!-- Overview View -->
        <div class="overview-container" id="overview-container">
            <div class="page-header">
                <div class="page-title">
                    <div class="sidebar-logo">P</div>
                    <div>
                        <h1>Command Center</h1>
                        <div class="updated">Updated <span id="update-time"></span></div>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div class="sync-status" id="sync-status">
                        <div class="sync-dot" id="sync-dot"></div>
                        <span id="sync-text">Synced</span>
                    </div>
                    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark mode" id="theme-toggle">üåô</button>
                    <button class="btn btn-secondary" onclick="refreshData()"><span>üîÑ</span> Refresh</button>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon green">‚úì</div>
                        <span class="stat-label">Completed</span>
                    </div>
                    <div class="stat-value" id="stat-completed">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon blue">‚óê</div>
                        <span class="stat-label">In Progress</span>
                    </div>
                    <div class="stat-value" id="stat-progress">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon red">!</div>
                        <span class="stat-label">High Priority</span>
                    </div>
                    <div class="stat-value" id="stat-priority">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon purple">‚ñ£</div>
                        <span class="stat-label">Active Projects</span>
                    </div>
                    <div class="stat-value" id="stat-projects">0</div>
                </div>
            </div>

            <!-- View Tabs -->
            <div class="view-tabs">
                <button class="view-tab active" onclick="setViewTab(this, 'projects')"><span>üìä</span> Projects</button>
                <button class="view-tab" onclick="setViewTab(this, 'tasks')"><span>üìã</span> All Tasks</button>
            </div>

            <!-- Projects Section -->
            <div id="projects-view">
                <div class="section-title">Projects</div>
                <div class="projects-grid" id="projects-grid"></div>
                <button class="btn btn-primary" onclick="openProjectModal()">+ Add Project</button>
            </div>
        </div>

        <!-- Kanban View -->
        <div class="kanban-container" id="kanban-container">
            <div class="back-btn" onclick="showOverview()">‚Üê Back to projects</div>

            <div class="kanban-header">
                <div class="kanban-project-info">
                    <div class="kanban-project-icon" id="kanban-project-icon">AF</div>
                    <div>
                        <div class="kanban-project-name" id="kanban-project-name">Project Name</div>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="openProjectSettings()">‚öôÔ∏è Settings</button>
            </div>

            <div class="kanban-tabs">
                <div class="kanban-tab active">Tasks</div>
                <div class="kanban-tab">Timeline</div>
            </div>

            <div class="kanban-filters">
                <span style="color: var(--text-secondary); margin-right: 8px;">Filter:</span>
                <button class="filter-chip active" onclick="filterKanban(this, 'all')">All</button>
                <button class="filter-chip" onclick="filterKanban(this, 'bug')" style="color: var(--red);">Bugs</button>
                <button class="filter-chip" onclick="filterKanban(this, 'feature')" style="color: var(--purple);">Features</button>
                <button class="filter-chip" onclick="filterKanban(this, 'task')">Tasks</button>
            </div>

            <div class="kanban-board" id="kanban-board">
                <div class="kanban-column" data-status="not-started">
                    <div class="column-header">
                        <div class="column-dot" style="background: #888;"></div>
                        <span class="column-title">Not Started</span>
                        <span class="column-count" id="count-not-started">0</span>
                    </div>
                    <div class="task-list" id="list-not-started"></div>
                    <button class="add-task-btn" onclick="openTaskModal('not-started')">+ New task</button>
                </div>

                <div class="kanban-column" data-status="in-progress">
                    <div class="column-header">
                        <div class="column-dot" style="background: var(--blue);"></div>
                        <span class="column-title" style="color: var(--blue);">In Progress</span>
                        <span class="column-count" id="count-in-progress">0</span>
                    </div>
                    <div class="task-list" id="list-in-progress"></div>
                    <button class="add-task-btn" onclick="openTaskModal('in-progress')">+ New task</button>
                </div>

                <div class="kanban-column" data-status="testing">
                    <div class="column-header">
                        <div class="column-dot" style="background: var(--yellow);"></div>
                        <span class="column-title" style="color: var(--yellow);">Testing</span>
                        <span class="column-count" id="count-testing">0</span>
                    </div>
                    <div class="task-list" id="list-testing"></div>
                    <button class="add-task-btn" onclick="openTaskModal('testing')">+ New task</button>
                </div>

                <div class="kanban-column" data-status="blocked">
                    <div class="column-header">
                        <div class="column-dot" style="background: var(--red);"></div>
                        <span class="column-title" style="color: var(--red);">Blocked</span>
                        <span class="column-count" id="count-blocked">0</span>
                    </div>
                    <div class="task-list" id="list-blocked"></div>
                    <button class="add-task-btn" onclick="openTaskModal('blocked')">+ New task</button>
                </div>

                <div class="kanban-column" data-status="completed">
                    <div class="column-header">
                        <div class="column-dot" style="background: var(--green);"></div>
                        <span class="column-title" style="color: var(--green);">Done</span>
                        <span class="column-count" id="count-completed">0</span>
                    </div>
                    <div class="task-list" id="list-completed"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Project Modal -->
    <div class="modal" id="project-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="project-modal-title">Add Project</div>
                <button class="modal-close" onclick="closeProjectModal()">√ó</button>
            </div>

            <div class="form-group">
                <label class="form-label">Project Name</label>
                <input type="text" class="form-input" id="project-name-input" placeholder="e.g. Air Fresh Marketing">
            </div>

            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-input form-textarea" id="project-desc-input" placeholder="Project description..."></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Slack Channel</label>
                <input type="text" class="form-input" id="project-slack-input" placeholder="e.g. #airfresh">
            </div>

            <div class="form-group">
                <label class="form-label">Color</label>
                <div class="color-options" id="color-options">
                    <div class="color-option selected" style="background: #8b5cf6;" data-color="#8b5cf6"></div>
                    <div class="color-option" style="background: #3b82f6;" data-color="#3b82f6"></div>
                    <div class="color-option" style="background: #22c55e;" data-color="#22c55e"></div>
                    <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b"></div>
                    <div class="color-option" style="background: #ef4444;" data-color="#ef4444"></div>
                    <div class="color-option" style="background: #ec4899;" data-color="#ec4899"></div>
                    <div class="color-option" style="background: #06b6d4;" data-color="#06b6d4"></div>
                    <div class="color-option" style="background: #64748b;" data-color="#64748b"></div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Status</label>
                <div class="status-options">
                    <button type="button" class="status-option selected" data-status="active">Active</button>
                    <button type="button" class="status-option" data-status="backlog">Backlog</button>
                    <button type="button" class="status-option" data-status="on-hold">On Hold</button>
                    <button type="button" class="status-option" data-status="completed">Completed</button>
                    <button type="button" class="status-option" data-status="archived">Archived</button>
                </div>
            </div>

            <input type="hidden" id="project-id-input">

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeProjectModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveProject()">Save</button>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div class="modal" id="task-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="task-modal-title">Add Task</div>
                <button class="modal-close" onclick="closeTaskModal()">√ó</button>
            </div>

            <div class="form-group">
                <label class="form-label">Task Title</label>
                <input type="text" class="form-input" id="task-title-input" placeholder="e.g. Update website banner">
            </div>

            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-input form-textarea" id="task-desc-input" placeholder="Task details..."></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Type</label>
                <div class="status-options">
                    <button type="button" class="status-option selected" data-type="task">Task</button>
                    <button type="button" class="status-option" data-type="bug">Bug</button>
                    <button type="button" class="status-option" data-type="feature">Feature</button>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Priority</label>
                <div class="status-options">
                    <button type="button" class="status-option" data-priority="low">Low</button>
                    <button type="button" class="status-option selected" data-priority="medium">Medium</button>
                    <button type="button" class="status-option" data-priority="high">High</button>
                    <button type="button" class="status-option" data-priority="critical">Critical</button>
                </div>
            </div>

            <input type="hidden" id="task-id-input">
            <input type="hidden" id="task-status-input">

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="deleteTask()" id="delete-task-btn" style="margin-right: auto; background: rgba(239, 68, 68, 0.2); color: var(--red); display: none;">Delete</button>
                <button class="btn btn-secondary" onclick="closeTaskModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveTask()">Save</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://prdhntwypgaakppvklbq.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_BHzTCuZc4a499d8uIMBGyQ_CUXtajbH';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Data Store
        let projects = [];
        let tasks = [];
        let currentProjectId = null;
        let currentFilter = 'all';

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            loadTheme();
            await loadData();
            render();
            updateTime();
            setInterval(updateTime, 60000);

            // Set up real-time subscriptions
            setupRealtimeSubscriptions();
        });

        // Theme
        function loadTheme() {
            const savedTheme = localStorage.getItem('pepper_theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                document.getElementById('theme-toggle').textContent = '‚òÄÔ∏è';
            }
        }

        function toggleTheme() {
            const isLight = document.body.classList.toggle('light-mode');
            localStorage.setItem('pepper_theme', isLight ? 'light' : 'dark');
            document.getElementById('theme-toggle').textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
        }

        // Sync Status
        function setSyncStatus(status) {
            const dot = document.getElementById('sync-dot');
            const text = document.getElementById('sync-text');
            dot.className = 'sync-dot';

            if (status === 'syncing') {
                dot.classList.add('syncing');
                text.textContent = 'Syncing...';
            } else if (status === 'error') {
                dot.classList.add('error');
                text.textContent = 'Sync error';
            } else {
                text.textContent = 'Synced';
            }
        }

        // Loading
        function setLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        // Data Functions
        async function loadData() {
            setLoading(true);
            setSyncStatus('syncing');

            try {
                // Load projects
                const { data: projectData, error: projectError } = await supabase
                    .from('projects')
                    .select('*')
                    .order('created_at', { ascending: true });

                if (projectError) throw projectError;
                projects = projectData || [];

                // Load tasks
                const { data: taskData, error: taskError } = await supabase
                    .from('tasks')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (taskError) throw taskError;
                tasks = taskData || [];

                setSyncStatus('synced');
            } catch (error) {
                console.error('Error loading data:', error);
                setSyncStatus('error');

                // Fallback to localStorage if Supabase fails
                const saved = localStorage.getItem('pepper_command_center');
                if (saved) {
                    const data = JSON.parse(saved);
                    projects = data.projects || [];
                    tasks = data.tasks || [];
                }
            } finally {
                setLoading(false);
            }
        }

        async function refreshData() {
            await loadData();
            render();
        }

        // Real-time Subscriptions
        function setupRealtimeSubscriptions() {
            // Subscribe to projects changes
            supabase
                .channel('projects-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'projects' }, () => {
                    refreshData();
                })
                .subscribe();

            // Subscribe to tasks changes
            supabase
                .channel('tasks-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, () => {
                    refreshData();
                })
                .subscribe();
        }

        function updateTime() {
            const now = new Date();
            document.getElementById('update-time').textContent = now.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        // Render Functions
        function render() {
            renderSidebar();
            renderStats();
            renderProjects();
            if (currentProjectId) {
                renderKanban();
            }
        }

        function renderSidebar() {
            const container = document.getElementById('sidebar-projects');
            container.innerHTML = projects
                .filter(p => p.status !== 'archived')
                .map(p => `
                    <div class="project-link ${currentProjectId === p.id ? 'active' : ''}" onclick="openProject('${p.id}')">
                        <div class="project-icon" style="background: ${p.color}20; color: ${p.color};">
                            ${p.name.substring(0, 2).toUpperCase()}
                        </div>
                        <span>${p.name}</span>
                    </div>
                `).join('');
        }

        function renderStats() {
            const completed = tasks.filter(t => t.status === 'completed').length;
            const inProgress = tasks.filter(t => t.status === 'in-progress').length;
            const highPriority = tasks.filter(t => t.priority === 'high' || t.priority === 'critical').length;
            const activeProjects = projects.filter(p => p.status === 'active').length;

            document.getElementById('stat-completed').textContent = completed;
            document.getElementById('stat-progress').textContent = inProgress;
            document.getElementById('stat-priority').textContent = highPriority;
            document.getElementById('stat-projects').textContent = activeProjects;
        }

        function renderProjects() {
            const container = document.getElementById('projects-grid');
            container.innerHTML = projects
                .filter(p => p.status !== 'archived')
                .map(p => {
                    const projectTasks = tasks.filter(t => t.project_id === p.id);
                    const completed = projectTasks.filter(t => t.status === 'completed').length;
                    const total = projectTasks.length;
                    const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
                    const active = projectTasks.filter(t => t.status !== 'completed').length;

                    return `
                        <div class="project-card" onclick="openProject('${p.id}')">
                            <div class="project-card-header">
                                <div class="project-card-icon" style="background: ${p.color}20; color: ${p.color};">
                                    ${p.name.substring(0, 2).toUpperCase()}
                                </div>
                                <div class="project-card-info">
                                    <div class="project-card-name">${p.name}</div>
                                    <div class="project-card-tasks">${completed} of ${total} done ¬∑ ${active} active</div>
                                </div>
                                <div class="project-card-percent">${percent}%</div>
                            </div>
                            <div class="project-progress">
                                <div class="project-progress-bar" style="width: ${percent}%; background: ${p.color};"></div>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        function renderKanban() {
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) return;

            document.getElementById('kanban-project-name').textContent = project.name;
            const icon = document.getElementById('kanban-project-icon');
            icon.textContent = project.name.substring(0, 2).toUpperCase();
            icon.style.background = `${project.color}20`;
            icon.style.color = project.color;

            const statuses = ['not-started', 'in-progress', 'testing', 'blocked', 'completed'];
            const projectTasks = tasks.filter(t => t.project_id === currentProjectId);

            statuses.forEach(status => {
                const list = document.getElementById(`list-${status}`);
                const filteredTasks = projectTasks.filter(t => {
                    if (t.status !== status) return false;
                    if (currentFilter === 'all') return true;
                    return t.type === currentFilter;
                });

                document.getElementById(`count-${status}`).textContent = filteredTasks.length;

                list.innerHTML = filteredTasks.map(t => `
                    <div class="task-card" draggable="true" data-task-id="${t.id}" onclick="openTaskModal('${status}', '${t.id}')">
                        <div class="task-title">${t.title}</div>
                        <div class="task-meta">
                            ${t.priority === 'high' || t.priority === 'critical' ? `<span class="task-tag due">${t.priority}</span>` : ''}
                            ${t.type !== 'task' ? `<span class="task-tag" style="background: ${t.type === 'bug' ? 'rgba(239,68,68,0.2); color: var(--red)' : 'rgba(139,92,246,0.2); color: var(--purple)'};">${t.type}</span>` : ''}
                            ${t.source === 'slack' ? `<span class="task-tag" style="background: rgba(59,130,246,0.2); color: var(--blue);">slack</span>` : ''}
                        </div>
                    </div>
                `).join('');
            });

            setupDragAndDrop();
        }

        // Navigation
        function showOverview() {
            currentProjectId = null;
            document.getElementById('overview-container').classList.remove('hidden');
            document.getElementById('kanban-container').classList.remove('active');
            document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));
            document.querySelector('.sidebar-nav a').classList.add('active');
            document.querySelectorAll('.project-link').forEach(l => l.classList.remove('active'));
            render();
        }

        function openProject(projectId) {
            currentProjectId = projectId;
            document.getElementById('overview-container').classList.add('hidden');
            document.getElementById('kanban-container').classList.add('active');
            document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));
            renderSidebar();
            renderKanban();
        }

        function showAllTasks() { showOverview(); }

        function setViewTab(btn, view) {
            document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
        }

        function filterKanban(btn, filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            renderKanban();
        }

        // Project Modal
        function openProjectModal(projectId = null) {
            const modal = document.getElementById('project-modal');
            const titleEl = document.getElementById('project-modal-title');

            if (projectId) {
                const project = projects.find(p => p.id === projectId);
                titleEl.textContent = 'Edit Project';
                document.getElementById('project-name-input').value = project.name;
                document.getElementById('project-desc-input').value = project.description || '';
                document.getElementById('project-slack-input').value = project.slack_channel || '';
                document.getElementById('project-id-input').value = project.id;

                document.querySelectorAll('.color-option').forEach(c => {
                    c.classList.toggle('selected', c.dataset.color === project.color);
                });
                document.querySelectorAll('.status-option[data-status]').forEach(s => {
                    s.classList.toggle('selected', s.dataset.status === project.status);
                });
            } else {
                titleEl.textContent = 'Add Project';
                document.getElementById('project-name-input').value = '';
                document.getElementById('project-desc-input').value = '';
                document.getElementById('project-slack-input').value = '';
                document.getElementById('project-id-input').value = '';

                document.querySelectorAll('.color-option').forEach((c, i) => c.classList.toggle('selected', i === 0));
                document.querySelectorAll('.status-option[data-status]').forEach((s, i) => s.classList.toggle('selected', i === 0));
            }

            modal.classList.add('active');
        }

        function openProjectSettings() { openProjectModal(currentProjectId); }
        function closeProjectModal() { document.getElementById('project-modal').classList.remove('active'); }

        async function saveProject() {
            const id = document.getElementById('project-id-input').value;
            const name = document.getElementById('project-name-input').value.trim();
            const description = document.getElementById('project-desc-input').value.trim();
            const slack_channel = document.getElementById('project-slack-input').value.trim();
            const color = document.querySelector('.color-option.selected')?.dataset.color || '#8b5cf6';
            const status = document.querySelector('.status-option[data-status].selected')?.dataset.status || 'active';

            if (!name) { alert('Please enter a project name'); return; }

            setSyncStatus('syncing');

            try {
                if (id) {
                    const { error } = await supabase
                        .from('projects')
                        .update({ name, description, slack_channel, color, status })
                        .eq('id', id);
                    if (error) throw error;
                } else {
                    const { error } = await supabase
                        .from('projects')
                        .insert([{ name, description, slack_channel, color, status }]);
                    if (error) throw error;
                }

                await refreshData();
                closeProjectModal();
                setSyncStatus('synced');
            } catch (error) {
                console.error('Error saving project:', error);
                setSyncStatus('error');
                alert('Failed to save project');
            }
        }

        // Task Modal
        function openTaskModal(status, taskId = null) {
            const modal = document.getElementById('task-modal');
            const titleEl = document.getElementById('task-modal-title');
            const deleteBtn = document.getElementById('delete-task-btn');

            document.getElementById('task-status-input').value = status;

            if (taskId) {
                const task = tasks.find(t => t.id === taskId);
                titleEl.textContent = 'Edit Task';
                document.getElementById('task-title-input').value = task.title;
                document.getElementById('task-desc-input').value = task.description || '';
                document.getElementById('task-id-input').value = task.id;
                deleteBtn.style.display = 'block';

                document.querySelectorAll('.status-option[data-type]').forEach(s => s.classList.toggle('selected', s.dataset.type === task.type));
                document.querySelectorAll('.status-option[data-priority]').forEach(s => s.classList.toggle('selected', s.dataset.priority === task.priority));
            } else {
                titleEl.textContent = 'Add Task';
                document.getElementById('task-title-input').value = '';
                document.getElementById('task-desc-input').value = '';
                document.getElementById('task-id-input').value = '';
                deleteBtn.style.display = 'none';

                document.querySelectorAll('.status-option[data-type]').forEach((s, i) => s.classList.toggle('selected', i === 0));
                document.querySelectorAll('.status-option[data-priority]').forEach((s, i) => s.classList.toggle('selected', i === 1));
            }

            modal.classList.add('active');
        }

        function closeTaskModal() { document.getElementById('task-modal').classList.remove('active'); }

        async function saveTask() {
            const id = document.getElementById('task-id-input').value;
            const title = document.getElementById('task-title-input').value.trim();
            const description = document.getElementById('task-desc-input').value.trim();
            const status = document.getElementById('task-status-input').value;
            const type = document.querySelector('.status-option[data-type].selected')?.dataset.type || 'task';
            const priority = document.querySelector('.status-option[data-priority].selected')?.dataset.priority || 'medium';

            if (!title) { alert('Please enter a task title'); return; }

            setSyncStatus('syncing');

            try {
                if (id) {
                    const { error } = await supabase
                        .from('tasks')
                        .update({ title, description, type, priority })
                        .eq('id', id);
                    if (error) throw error;
                } else {
                    const { error } = await supabase
                        .from('tasks')
                        .insert([{
                            project_id: currentProjectId,
                            title,
                            description,
                            status,
                            type,
                            priority,
                            source: 'manual'
                        }]);
                    if (error) throw error;
                }

                await refreshData();
                closeTaskModal();
                setSyncStatus('synced');
            } catch (error) {
                console.error('Error saving task:', error);
                setSyncStatus('error');
                alert('Failed to save task');
            }
        }

        async function deleteTask() {
            const id = document.getElementById('task-id-input').value;
            if (!id || !confirm('Delete this task?')) return;

            setSyncStatus('syncing');

            try {
                const { error } = await supabase.from('tasks').delete().eq('id', id);
                if (error) throw error;

                await refreshData();
                closeTaskModal();
                setSyncStatus('synced');
            } catch (error) {
                console.error('Error deleting task:', error);
                setSyncStatus('error');
                alert('Failed to delete task');
            }
        }

        // Drag and Drop
        function setupDragAndDrop() {
            const taskCards = document.querySelectorAll('.task-card');
            const taskLists = document.querySelectorAll('.task-list');

            taskCards.forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
            });

            taskLists.forEach(list => {
                list.addEventListener('dragover', handleDragOver);
                list.addEventListener('drop', handleDrop);
                list.addEventListener('dragleave', handleDragLeave);
            });
        }

        let draggedTask = null;

        function handleDragStart(e) {
            draggedTask = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.task-list').forEach(list => list.style.background = '');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.style.background = 'rgba(139, 92, 246, 0.1)';
        }

        function handleDragLeave(e) { e.currentTarget.style.background = ''; }

        async function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.style.background = '';

            if (!draggedTask) return;

            const taskId = draggedTask.dataset.taskId;
            const column = e.currentTarget.closest('.kanban-column');
            const newStatus = column.dataset.status;

            setSyncStatus('syncing');

            try {
                const { error } = await supabase
                    .from('tasks')
                    .update({ status: newStatus })
                    .eq('id', taskId);

                if (error) throw error;

                await refreshData();
                setSyncStatus('synced');
            } catch (error) {
                console.error('Error updating task:', error);
                setSyncStatus('error');
            }
        }

        // Event Listeners
        document.querySelectorAll('.color-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.color-option').forEach(c => c.classList.remove('selected'));
                option.classList.add('selected');
            });
        });

        document.querySelectorAll('.status-option[data-status]').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.status-option[data-status]').forEach(s => s.classList.remove('selected'));
                option.classList.add('selected');
            });
        });

        document.querySelectorAll('.status-option[data-type]').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.status-option[data-type]').forEach(s => s.classList.remove('selected'));
                option.classList.add('selected');
            });
        });

        document.querySelectorAll('.status-option[data-priority]').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.status-option[data-priority]').forEach(s => s.classList.remove('selected'));
                option.classList.add('selected');
            });
        });

        document.getElementById('project-modal').addEventListener('click', (e) => {
            if (e.target.id === 'project-modal') closeProjectModal();
        });

        document.getElementById('task-modal').addEventListener('click', (e) => {
            if (e.target.id === 'task-modal') closeTaskModal();
        });
    </script>
</body>
</html>
