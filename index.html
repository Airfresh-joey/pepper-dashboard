<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå∂Ô∏è Joey's Command Center</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/apple-touch-icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pepper">
    <meta name="theme-color" content="#0a0a0a">
    <style>
        /* Login Overlay Styles */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        .login-overlay.hidden { display: none; }
        
        .login-box {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 3rem;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .login-box h2 {
            color: #fff;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .login-box p {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 2rem;
        }
        .login-box input {
            width: 100%;
            padding: 1rem;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            color: #fff;
            font-size: 1rem;
            text-align: center;
            margin-bottom: 1rem;
            outline: none;
        }
        .login-box input:focus {
            border-color: #e82127;
        }
        .login-box input::placeholder {
            color: #666;
        }
        .login-box button {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #e82127, #c91c21);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .login-box button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(232,33,39,0.4);
        }
        .login-error {
            color: #e82127;
            font-size: 0.85rem;
            margin-top: 1rem;
            min-height: 1.5rem;
        }
        .login-logo {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        /* Keypad Styles */
        .keypad-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        .keypad-overlay.hidden { display: none; }
        
        .keypad-title {
            color: #888;
            font-size: 1rem;
            margin-bottom: 2rem;
        }
        .keypad-display {
            font-size: 2.5rem;
            letter-spacing: 0.8rem;
            margin-bottom: 2rem;
            color: #e82127;
        }
        .keypad-grid {
            display: grid;
            grid-template-columns: repeat(3, 70px);
            gap: 12px;
        }
        .key-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 2px solid rgba(232,33,39,0.3);
            background: rgba(255,255,255,0.03);
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .key-btn:hover {
            background: rgba(232,33,39,0.2);
            border-color: #e82127;
        }
        .key-btn:active { transform: scale(0.95); }
        .key-btn.clear { font-size: 0.8rem; color: #888; }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header { padding: 0.75rem 1rem; }
            .header-content { flex-direction: column; gap: 0.5rem; }
            .header-left { flex-direction: column; text-align: center; }
            .header-right { width: 100%; justify-content: center; }
            .branding h1 { font-size: 1.2rem; }
            
            .container { padding: 0.75rem; }
            .dept-grid { grid-template-columns: 1fr; }
            .kanban-grid { grid-template-columns: 1fr; }
            
            .task-card { padding: 0.75rem; }
            .task-title { font-size: 0.9rem; }
            
            .blockers-section { margin: 0.5rem 0; padding: 0.75rem; }
            
            .login-box { padding: 2rem 1.5rem; }
            .keypad-grid { grid-template-columns: repeat(3, 60px); gap: 10px; }
            .key-btn { width: 60px; height: 60px; font-size: 1.3rem; }
        }
        
        @media (max-width: 480px) {
            .header-right .refresh-btn { padding: 0.5rem 0.8rem; font-size: 0.8rem; }
            .clock { font-size: 0.85rem; }
            .section-header h2 { font-size: 0.9rem; }
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            left: -280px;
            top: 0;
            width: 280px;
            height: 100vh;
            background: #1a1a2e;
            border-right: 1px solid #333;
            z-index: 99999;
            transition: left 0.3s ease;
            overflow-y: auto;
            box-shadow: 4px 0 20px rgba(0,0,0,0.5);
        }
        .sidebar.open { left: 0 !important; }
        body.light-theme .sidebar { background: #fff; border-right: 1px solid #e0e0e0; box-shadow: 4px 0 20px rgba(0,0,0,0.1); }
        body.light-theme .sidebar-title { color: #1a1a1a; }
        body.light-theme .sidebar-label { color: #666; }
        body.light-theme .sidebar-item { color: #333; }
        body.light-theme .sidebar-item:hover { background: #f0f0f0; }
        body.light-theme .sidebar-close { color: #666; }
        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px;
            border-bottom: 1px solid #333;
        }
        .sidebar-logo { font-size: 1.8rem; }
        .sidebar-title { font-size: 1.2rem; font-weight: 700; color: #fff; flex: 1; }
        .sidebar-close {
            background: none;
            border: none;
            color: #888;
            font-size: 1.2rem;
            cursor: pointer;
        }
        .sidebar-section { padding: 15px 20px; }
        .sidebar-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #666;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .sidebar-item {
            display: block;
            padding: 10px 12px;
            color: #ccc;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .sidebar-item:hover { background: #1a1a1a; color: #fff; }
        .sidebar-item.active { background: #e82127; color: #fff; }
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 99998;
            display: none;
        }
        .sidebar-overlay.show { display: block !important; }
    </style>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Tesla-style dark theme colors */
            --bg-primary: #0a0a0a;
            --bg-secondary: #141414;
            --bg-tertiary: #1a1a1a;
            --bg-card: #1e1e1e;
            --bg-hover: #252525;
            --border-color: #2a2a2a;
            --border-light: #333;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-muted: #666;
            --accent-red: #e82127;
            --accent-blue: #3b82f6;
            --accent-green: #22c55e;
            --accent-yellow: #eab308;
            --accent-purple: #a855f7;
            --accent-orange: #f97316;
            --accent-cyan: #06b6d4;
            --accent-pink: #ec4899;
            
            /* Department colors */
            --dept-airfresh: #06b6d4;
            --dept-streetteams: #22d3ee;
            --dept-humming: #a855f7;
            --dept-webdev: #22c55e;
            --dept-operations: #f97316;
            --dept-sales: #3b82f6;
            --dept-legal: #eab308;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* Header - Tesla style minimal */
        .header {
            background: var(--bg-secondary);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--border-color);
        }

        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            font-size: 2rem;
        }

        .branding h1 {
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .clock {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-variant-numeric: tabular-nums;
        }

        .refresh-btn {
            background: transparent;
            border: 1px solid var(--border-light);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        /* Main Container */
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 1.5rem 2rem;
        }

        /* Blockers Section - Always at top */
        .blockers-section {
            background: linear-gradient(135deg, rgba(232, 33, 39, 0.1) 0%, rgba(232, 33, 39, 0.05) 100%);
            border: 1px solid rgba(232, 33, 39, 0.3);
            border-radius: 12px;
            padding: 1.25rem 1.5rem;
            margin-bottom: 1.5rem;
        }

        .blockers-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .blockers-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent-red);
        }

        .blockers-count {
            background: var(--accent-red);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 700;
        }

        .blockers-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .blocker-item {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-left: 3px solid var(--accent-red);
            padding: 0.75rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .blocker-dept {
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .no-blockers {
            color: var(--accent-green);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        /* Quick Stats Row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1rem 1.25rem;
            transition: all 0.2s;
        }

        .stat-card:hover {
            border-color: var(--border-light);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            line-height: 1;
        }

        .stat-value.green { color: var(--accent-green); }
        .stat-value.yellow { color: var(--accent-yellow); }
        .stat-value.red { color: var(--accent-red); }
        .stat-value.blue { color: var(--accent-blue); }
        .stat-value.purple { color: var(--accent-purple); }

        /* View Toggle */
        .view-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
        }

        .view-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .view-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .dept-filter {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
        }

        .add-task-btn {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 0.5rem 1.25rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-task-btn:hover {
            background: #2563eb;
        }

        /* Kanban Board */
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .kanban-column {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            min-height: 500px;
            display: flex;
            flex-direction: column;
        }

        .column-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .column-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .column-title.todo { color: var(--text-secondary); }
        .column-title.progress { color: var(--accent-blue); }
        .column-title.blocked { color: var(--accent-red); }
        .column-title.done { color: var(--accent-green); }

        .column-count {
            background: var(--bg-hover);
            padding: 0.25rem 0.625rem;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .tasks-container {
            padding: 0.75rem;
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        /* Task Cards */
        .task-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            cursor: grab;
            transition: all 0.2s;
            position: relative;
        }

        .task-card:hover {
            border-color: var(--border-light);
            transform: translateY(-2px);
        }

        .task-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .task-dept-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            border-radius: 8px 8px 0 0;
        }

        .task-dept-bar.airfresh { background: var(--dept-airfresh); }
        .task-dept-bar.streetteams { background: var(--dept-streetteams); }
        .task-dept-bar.humming { background: var(--dept-humming); }
        .task-dept-bar.webdev { background: var(--dept-webdev); }
        .task-dept-bar.operations { background: var(--dept-operations); }
        .task-dept-bar.sales { background: var(--dept-sales); }
        .task-dept-bar.legal { background: var(--dept-legal); }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .task-dept-label {
            font-size: 0.7rem;
            padding: 0.125rem 0.5rem;
            border-radius: 3px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .task-dept-label.airfresh { background: rgba(6, 182, 212, 0.2); color: var(--dept-airfresh); }
        .task-dept-label.streetteams { background: rgba(34, 211, 238, 0.2); color: var(--dept-streetteams); }
        .task-dept-label.humming { background: rgba(168, 85, 247, 0.2); color: var(--dept-humming); }
        .task-dept-label.webdev { background: rgba(34, 197, 94, 0.2); color: var(--dept-webdev); }
        .task-dept-label.operations { background: rgba(249, 115, 22, 0.2); color: var(--dept-operations); }
        .task-dept-label.sales { background: rgba(59, 130, 246, 0.2); color: var(--dept-sales); }
        .task-dept-label.legal { background: rgba(234, 179, 8, 0.2); color: var(--dept-legal); }

        .task-title {
            font-size: 0.95rem;
            font-weight: 500;
            line-height: 1.4;
            margin-bottom: 0.75rem;
        }

        /* Progress Bar */
        .task-progress {
            margin-bottom: 0.75rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.375rem;
        }

        .progress-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .progress-percent {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .progress-bar {
            height: 4px;
            background: var(--bg-hover);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s;
        }

        .progress-fill.low { background: var(--accent-red); }
        .progress-fill.medium { background: var(--accent-yellow); }
        .progress-fill.high { background: var(--accent-green); }

        /* Task Meta */
        .task-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .task-meta-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .task-meta-item.overdue {
            color: var(--accent-red);
        }

        .task-meta-item.soon {
            color: var(--accent-yellow);
        }

        /* Department Status Panel */
        .dept-status-panel {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .dept-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1.25rem;
            transition: all 0.2s;
        }

        .dept-card:hover {
            border-color: var(--border-light);
        }

        .dept-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .dept-name {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }

        .dept-icon {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .dept-icon.airfresh { background: var(--dept-airfresh); }
        .dept-icon.streetteams { background: var(--dept-streetteams); }
        .dept-icon.humming { background: var(--dept-humming); }
        .dept-icon.webdev { background: var(--dept-webdev); }
        .dept-icon.operations { background: var(--dept-operations); }
        .dept-icon.sales { background: var(--dept-sales); }
        .dept-icon.legal { background: var(--dept-legal); }

        .dept-status-badge {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .dept-status-badge.operational {
            background: rgba(34, 197, 94, 0.2);
            color: var(--accent-green);
        }

        .dept-status-badge.active {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-blue);
        }

        .dept-status-badge.blocked {
            background: rgba(232, 33, 39, 0.2);
            color: var(--accent-red);
        }

        .dept-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            text-align: center;
        }

        .dept-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .dept-stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            width: 100%;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            font-family: inherit;
            outline: none;
            transition: all 0.2s;
        }

        .form-input:focus {
            border-color: var(--accent-blue);
        }

        textarea.form-input {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-secondary);
        }

        .btn-secondary:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .kanban-board {
                grid-template-columns: repeat(2, 1fr);
            }
            .stats-row {
                grid-template-columns: repeat(3, 1fr);
            }
            .dept-status-panel {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            .kanban-board {
                grid-template-columns: 1fr;
            }
            .stats-row {
                grid-template-columns: repeat(2, 1fr);
            }
            .dept-status-panel {
                grid-template-columns: 1fr;
            }
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-light);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
    </style>
</head>
<body>
    <!-- Password Login Overlay -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-box">
            <div class="login-logo">üå∂Ô∏è</div>
            <h2>Joey's Command Center</h2>
            <p>Enter password to continue</p>
            <input type="password" id="loginPassword" placeholder="Password" onkeypress="if(event.key==='Enter')checkPassword()">
            <button onclick="checkPassword()">Enter</button>
            <div class="login-error" id="loginError"></div>
        </div>
    </div>
    
    <!-- Keypad Overlay -->
    <div class="keypad-overlay hidden" id="keypadOverlay">
        <div class="login-logo" style="font-size:3rem;margin-bottom:1rem;">üå∂Ô∏è</div>
        <div class="keypad-title">Enter Access Code</div>
        <div class="keypad-display" id="keypadDisplay">‚óã‚óã‚óã‚óã</div>
        <div class="keypad-grid">
            <button class="key-btn" onclick="addKey('1')">1</button>
            <button class="key-btn" onclick="addKey('2')">2</button>
            <button class="key-btn" onclick="addKey('3')">3</button>
            <button class="key-btn" onclick="addKey('4')">4</button>
            <button class="key-btn" onclick="addKey('5')">5</button>
            <button class="key-btn" onclick="addKey('6')">6</button>
            <button class="key-btn" onclick="addKey('7')">7</button>
            <button class="key-btn" onclick="addKey('8')">8</button>
            <button class="key-btn" onclick="addKey('9')">9</button>
            <button class="key-btn clear" onclick="clearKeys()">CLR</button>
            <button class="key-btn" onclick="addKey('0')">0</button>
            <button class="key-btn" onclick="submitKeys()">‚Üµ</button>
        </div>
        <div class="login-error" id="keypadError"></div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span class="sidebar-logo">üå∂Ô∏è</span>
            <span class="sidebar-title">Pepper</span>
            <button class="sidebar-close" onclick="toggleSidebar()">‚úï</button>
        </div>
        
        <div class="sidebar-section">
            <div class="sidebar-label">Dashboard</div>
            <a class="sidebar-item active" onclick="showView('dashboard')">üìä Overview</a>
        </div>
        
        <div class="sidebar-section">
            <div class="sidebar-label">AI Products</div>
            <a class="sidebar-item" onclick="showView('bloom')">üå∏ BLOOM Proposals</a>
            <a class="sidebar-item" onclick="showView('nectar')">üçØ NECTAR CRM</a>
            <a class="sidebar-item" onclick="showView('atlas')">‚ö° ATLAS AI</a>
        </div>
        
        <div class="sidebar-section">
            <div class="sidebar-label">Departments</div>
            <a class="sidebar-item" onclick="filterDept('airfresh')">üå¨Ô∏è Air Fresh Marketing</a>
            <a class="sidebar-item" onclick="filterDept('streetteams')">üö∂ Street Teams Co</a>
            <a class="sidebar-item" onclick="filterDept('humming')">üêù Humming Agent</a>
            <a class="sidebar-item" onclick="filterDept('webdev')">üíª Web Development</a>
            <a class="sidebar-item" onclick="filterDept('operations')">‚öôÔ∏è Operations</a>
            <a class="sidebar-item" onclick="filterDept('sales')">üí∞ Sales</a>
            <a class="sidebar-item" onclick="filterDept('legal')">‚öñÔ∏è Legal</a>
        </div>
        
        <div class="sidebar-section">
            <div class="sidebar-label">üìß Email Accounts</div>
            <a class="sidebar-item" href="https://mail.google.com/mail/u/0/#inbox" target="_blank">joey@airfreshmarketing.com</a>
            <a class="sidebar-item" href="https://mail.google.com/mail/u/1/#inbox" target="_blank">hello@airfreshmarketing.com</a>
            <a class="sidebar-item" href="https://mail.google.com/mail/u/2/#inbox" target="_blank">hello@streetteamsco.com</a>
            <a class="sidebar-item" href="https://mail.google.com/mail/u/3/#inbox" target="_blank">forge@immerseforge.com</a>
            <a class="sidebar-item" href="https://mail.google.com/mail/u/4/#inbox" target="_blank">hey@collegemarketing.co</a>
            <a class="sidebar-item" href="https://mail.google.com/mail/u/5/#inbox" target="_blank">1@magen22.com</a>
        </div>
        
        <div class="sidebar-section">
            <div class="sidebar-label">Slack Channels</div>
            <a class="sidebar-item" href="https://app.slack.com/client/T095ZMAP5/C0AC79DH1L6" target="_blank">#labs</a>
            <a class="sidebar-item" href="https://app.slack.com/client/T095ZMAP5" target="_blank">#chief-of-staff</a>
            <a class="sidebar-item" href="https://app.slack.com/client/T095ZMAP5" target="_blank">#air-fresh</a>
        </div>
    </div>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="header-left">
                <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
                <span class="logo-icon">üå∂Ô∏è</span>
                <div class="branding">
                    <h1>Pepper</h1>
                </div>
            </div>
            <div class="header-right">
                <div class="theme-toggle" onclick="toggleTheme()">
                    <span class="theme-icon" id="sunIcon">‚òÄÔ∏è</span>
                    <span class="theme-icon active" id="moonIcon">üåô</span>
                </div>
                <button class="icon-btn" onclick="toggleNotifications()">üîî</button>
                <div class="clock" id="clock">--</div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Blockers Section -->
        <div class="blockers-section" id="blockersSection">
            <div class="blockers-header">
                <div class="blockers-title">
                    <span>üö®</span>
                    <span>Current Blockers</span>
                </div>
                <span class="blockers-count" id="blockersCount">0</span>
            </div>
            <div class="blockers-list" id="blockersList">
                <div class="no-blockers">‚úì No active blockers</div>
            </div>
        </div>

        <!-- Usage Stats -->
        <div class="usage-section" id="usageSection">
            <div class="usage-header">
                <span>üìä API Usage</span>
                <button onclick="refreshUsage()" style="background:none;border:none;cursor:pointer;font-size:1rem;">‚Üª</button>
            </div>
            <div class="usage-cards" id="usageCards">
                <div class="usage-card">
                    <div class="usage-service">ElevenLabs</div>
                    <div class="usage-bar"><div class="usage-fill" style="width:0%"></div></div>
                    <div class="usage-text">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-label">Todo</div>
                <div class="stat-value" id="stat-todo">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">In Progress</div>
                <div class="stat-value blue" id="stat-progress">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Blocked</div>
                <div class="stat-value red" id="stat-blocked">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Done</div>
                <div class="stat-value green" id="stat-done">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Overall Progress</div>
                <div class="stat-value purple" id="stat-overall">0%</div>
            </div>
        </div>

        <!-- AI Products Quick Access -->
        <div class="stats-row" style="margin-bottom: 1rem;">
            <div onclick="showView('bloom')" class="stat-card" style="cursor: pointer; border: 2px solid #f687b3; transition: all 0.2s;">
                <div class="stat-label" style="color: #f687b3;">üå∏ BLOOM</div>
                <div class="stat-value" style="font-size: 0.9rem; color: #fff;">Proposals</div>
            </div>
            <div onclick="showView('nectar')" class="stat-card" style="cursor: pointer; border: 2px solid #f6ad55; transition: all 0.2s;">
                <div class="stat-label" style="color: #f6ad55;">üçØ NECTAR</div>
                <div class="stat-value" style="font-size: 0.9rem; color: #fff;">CRM</div>
            </div>
            <div onclick="showView('atlas')" class="stat-card" style="cursor: pointer; border: 2px solid #667eea; transition: all 0.2s;">
                <div class="stat-label" style="color: #667eea;">‚ö° ATLAS</div>
                <div class="stat-value" style="font-size: 0.9rem; color: #fff;">AI Employee</div>
            </div>
        </div>

        <!-- Kanban Controls -->
        <div class="view-controls">
            <h2 class="view-title">Task Board</h2>
            <div class="view-actions">
                <select class="dept-filter" id="deptFilter" onchange="filterTasks()">
                    <option value="all">All Departments</option>
                    <option value="airfresh">Air Fresh Marketing</option>
                    <option value="streetteams">Street Teams Co</option>
                    <option value="humming">Humming Agent</option>
                    <option value="webdev">Web Development</option>
                    <option value="operations">Operations</option>
                    <option value="sales">Sales</option>
                    <option value="legal">Legal</option>
                </select>
                <button class="add-task-btn" onclick="openAddTaskModal()">+ Add Task</button>
            </div>
        </div>

        <!-- Kanban Board -->
        <div class="kanban-board">
            <div class="kanban-column">
                <div class="column-header">
                    <div class="column-title todo">
                        <span>üìã</span> TODO
                    </div>
                    <span class="column-count" id="count-todo">0</span>
                </div>
                <div class="tasks-container" id="tasks-todo" data-status="todo"></div>
            </div>

            <div class="kanban-column">
                <div class="column-header">
                    <div class="column-title progress">
                        <span>üîÑ</span> IN PROGRESS
                    </div>
                    <span class="column-count" id="count-progress">0</span>
                </div>
                <div class="tasks-container" id="tasks-progress" data-status="progress"></div>
            </div>

            <div class="kanban-column">
                <div class="column-header">
                    <div class="column-title blocked">
                        <span>‚õî</span> BLOCKED
                    </div>
                    <span class="column-count" id="count-blocked">0</span>
                </div>
                <div class="tasks-container" id="tasks-blocked" data-status="blocked"></div>
            </div>

            <div class="kanban-column">
                <div class="column-header">
                    <div class="column-title done">
                        <span>‚úÖ</span> DONE
                    </div>
                    <span class="column-count" id="count-done">0</span>
                </div>
                <div class="tasks-container" id="tasks-done" data-status="done"></div>
            </div>
        </div>

        <!-- Department Status Panel -->
        <div class="dept-status-panel" id="deptStatusPanel">
            <!-- Populated by JS -->
        </div>
    </div>

    <!-- Add Task Modal -->
    <div class="modal" id="addTaskModal">
        <div class="modal-content">
            <h2 class="modal-title">Add Task</h2>
            <form id="addTaskForm" onsubmit="addTask(event)">
                <div class="form-group">
                    <label class="form-label">Task Name</label>
                    <input type="text" id="taskTitle" class="form-input" required placeholder="What needs to be done?">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Department</label>
                        <select id="taskDept" class="form-input">
                            <option value="airfresh">Air Fresh Marketing</option>
                            <option value="streetteams">Street Teams Co</option>
                            <option value="humming">Humming Agent</option>
                            <option value="webdev">Web Development</option>
                            <option value="operations">Operations</option>
                            <option value="sales">Sales</option>
                            <option value="legal">Legal</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="taskStatus" class="form-input">
                            <option value="todo">Todo</option>
                            <option value="progress">In Progress</option>
                            <option value="blocked">Blocked</option>
                            <option value="done">Done</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Progress %</label>
                        <input type="number" id="taskProgress" class="form-input" min="0" max="100" value="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time Estimate</label>
                        <input type="text" id="taskTime" class="form-input" placeholder="e.g., 2h, 1d, 1w">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Due Date</label>
                    <input type="date" id="taskDue" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Blocker Note (if blocked)</label>
                    <textarea id="taskBlocker" class="form-input" placeholder="What's blocking this?"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAddTaskModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Task</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ============ SIDEBAR ============
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('show');
        }

        // ============ VIEW SWITCHING ============
        function showView(view) {
            // Close sidebar
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.remove('show');
            
            // Hide all product views
            document.getElementById('view-bloom').style.display = 'none';
            document.getElementById('view-nectar').style.display = 'none';
            document.getElementById('view-atlas').style.display = 'none';
            
            // Show the selected view or dashboard
            if (view === 'bloom') {
                document.getElementById('view-bloom').style.display = 'block';
            } else if (view === 'nectar') {
                document.getElementById('view-nectar').style.display = 'block';
            } else if (view === 'atlas') {
                document.getElementById('view-atlas').style.display = 'block';
            }
            // If 'dashboard', all views are hidden, showing main dashboard
            
            // Update active state
            document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
            if (view === 'dashboard') {
                document.querySelector('.sidebar-item[onclick*="dashboard"]').classList.add('active');
            }
        }
        
        function filterDept(dept) {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.remove('show');
            document.getElementById('deptFilter').value = dept;
            filterTasks();
        }

        // ============ DATA ============
        const DEPT_NAMES = {
            airfresh: 'Air Fresh',
            streetteams: 'Street Teams Co',
            humming: 'Humming Agent',
            webdev: 'Web Dev',
            operations: 'Operations',
            sales: 'Sales',
            legal: 'Legal'
        };

        const DEPT_STATUS = {
            airfresh: { status: 'operational', tasks: 2, progress: 10, blockers: 0 },
            streetteams: { status: 'operational', tasks: 0, progress: 0, blockers: 0 },
            humming: { status: 'operational', tasks: 2, progress: 45, blockers: 0 },
            webdev: { status: 'active', tasks: 4, progress: 60, blockers: 0 },
            operations: { status: 'operational', tasks: 3, progress: 30, blockers: 1 },
            sales: { status: 'operational', tasks: 2, progress: 20, blockers: 0 },
            legal: { status: 'operational', tasks: 1, progress: 50, blockers: 0 }
        };

        // Load tasks from localStorage or use defaults
        let tasks = JSON.parse(localStorage.getItem('kanban-tasks')) || [
            { id: 1, title: 'AFM Website Redesign', dept: 'airfresh', status: 'progress', progress: 10, time: '2w', due: '2026-02-15', blocker: '' },
            { id: 2, title: 'Client Campaign Q1', dept: 'airfresh', status: 'todo', progress: 0, time: '1w', due: '2026-02-01', blocker: '' },
            { id: 3, title: 'Skylead Outreach', dept: 'humming', status: 'progress', progress: 45, time: '3d', due: '2026-02-05', blocker: '' },
            { id: 4, title: 'AI Agent Development', dept: 'humming', status: 'progress', progress: 40, time: '1m', due: '2026-03-01', blocker: '' },
            { id: 5, title: 'ImmerseForge Login Links', dept: 'webdev', status: 'done', progress: 100, time: '2h', due: '2026-01-30', blocker: '' },
            { id: 6, title: 'Dashboard System', dept: 'webdev', status: 'progress', progress: 75, time: '1w', due: '2026-02-01', blocker: '' },
            { id: 7, title: 'Security Audit', dept: 'webdev', status: 'todo', progress: 0, time: '3d', due: '2026-02-10', blocker: '' },
            { id: 8, title: 'SSL Certificate Renewal', dept: 'webdev', status: 'todo', progress: 0, time: '1h', due: '2026-02-28', blocker: '' },
            { id: 9, title: 'Email Server Migration', dept: 'operations', status: 'blocked', progress: 30, time: '2d', due: '2026-02-05', blocker: 'Waiting for DNS propagation' },
            { id: 10, title: 'CRM Integration', dept: 'operations', status: 'progress', progress: 25, time: '1w', due: '2026-02-10', blocker: '' },
            { id: 11, title: 'Lead Pipeline Setup', dept: 'sales', status: 'todo', progress: 0, time: '3d', due: '2026-02-07', blocker: '' },
            { id: 12, title: 'Q1 Goals Review', dept: 'sales', status: 'progress', progress: 50, time: '2h', due: '2026-01-31', blocker: '' },
            { id: 13, title: 'Privacy Policy Update', dept: 'legal', status: 'progress', progress: 60, time: '4h', due: '2026-02-03', blocker: '' }
        ];

        // ============ RENDERING ============
        function renderTasks() {
            const filter = document.getElementById('deptFilter').value;
            const statuses = ['todo', 'progress', 'blocked', 'done'];
            
            statuses.forEach(status => {
                const container = document.getElementById(`tasks-${status}`);
                let filteredTasks = tasks.filter(t => t.status === status);
                if (filter !== 'all') {
                    filteredTasks = filteredTasks.filter(t => t.dept === filter);
                }
                
                if (filteredTasks.length === 0) {
                    container.innerHTML = '<div class="empty-state">No tasks</div>';
                } else {
                    container.innerHTML = filteredTasks.map(task => renderTaskCard(task)).join('');
                }
                
                document.getElementById(`count-${status}`).textContent = filteredTasks.length;
            });
            
            updateStats();
            updateBlockers();
            setupDragAndDrop();
            saveTasks();
        }

        function renderTaskCard(task) {
            const progressClass = task.progress < 30 ? 'low' : task.progress < 70 ? 'medium' : 'high';
            const dueDate = task.due ? new Date(task.due) : null;
            const now = new Date();
            let dueClass = '';
            let dueText = task.due || '--';
            
            if (dueDate) {
                const daysUntil = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));
                if (daysUntil < 0) {
                    dueClass = 'overdue';
                    dueText = `${Math.abs(daysUntil)}d overdue`;
                } else if (daysUntil <= 3) {
                    dueClass = 'soon';
                    dueText = daysUntil === 0 ? 'Today' : daysUntil === 1 ? 'Tomorrow' : `${daysUntil}d`;
                } else {
                    dueText = dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
            }

            return `
                <div class="task-card" draggable="true" data-task-id="${task.id}">
                    <div class="task-dept-bar ${task.dept}"></div>
                    <div class="task-header">
                        <span class="task-dept-label ${task.dept}">${DEPT_NAMES[task.dept]}</span>
                    </div>
                    <div class="task-title">${task.title}</div>
                    <div class="task-progress">
                        <div class="progress-header">
                            <span class="progress-label">Progress</span>
                            <span class="progress-percent">${task.progress}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${progressClass}" style="width: ${task.progress}%"></div>
                        </div>
                    </div>
                    <div class="task-meta">
                        <div class="task-meta-item">‚è± ${task.time || '--'}</div>
                        <div class="task-meta-item ${dueClass}">üìÖ ${dueText}</div>
                    </div>
                </div>
            `;
        }

        function updateStats() {
            const counts = {
                todo: tasks.filter(t => t.status === 'todo').length,
                progress: tasks.filter(t => t.status === 'progress').length,
                blocked: tasks.filter(t => t.status === 'blocked').length,
                done: tasks.filter(t => t.status === 'done').length
            };
            
            document.getElementById('stat-todo').textContent = counts.todo;
            document.getElementById('stat-progress').textContent = counts.progress;
            document.getElementById('stat-blocked').textContent = counts.blocked;
            document.getElementById('stat-done').textContent = counts.done;
            
            const total = tasks.length;
            const overallProgress = total > 0 
                ? Math.round(tasks.reduce((sum, t) => sum + t.progress, 0) / total)
                : 0;
            document.getElementById('stat-overall').textContent = overallProgress + '%';
        }

        function updateBlockers() {
            const blockedTasks = tasks.filter(t => t.status === 'blocked');
            const blockersList = document.getElementById('blockersList');
            const blockersCount = document.getElementById('blockersCount');
            
            blockersCount.textContent = blockedTasks.length;
            
            if (blockedTasks.length === 0) {
                blockersList.innerHTML = '<div class="no-blockers">‚úì No active blockers</div>';
                document.querySelector('.blockers-section').style.borderColor = 'rgba(34, 197, 94, 0.3)';
                document.querySelector('.blockers-section').style.background = 'linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(34, 197, 94, 0.05) 100%)';
            } else {
                blockersList.innerHTML = blockedTasks.map(t => `
                    <div class="blocker-item">
                        <span class="blocker-dept task-dept-label ${t.dept}">${DEPT_NAMES[t.dept]}</span>
                        <span><strong>${t.title}</strong>${t.blocker ? ': ' + t.blocker : ''}</span>
                    </div>
                `).join('');
                document.querySelector('.blockers-section').style.borderColor = 'rgba(232, 33, 39, 0.3)';
                document.querySelector('.blockers-section').style.background = 'linear-gradient(135deg, rgba(232, 33, 39, 0.1) 0%, rgba(232, 33, 39, 0.05) 100%)';
            }
        }

        function renderDeptStatus() {
            const panel = document.getElementById('deptStatusPanel');
            panel.innerHTML = Object.entries(DEPT_STATUS).map(([dept, data]) => `
                <div class="dept-card">
                    <div class="dept-header">
                        <div class="dept-name">
                            <div class="dept-icon ${dept}"></div>
                            ${DEPT_NAMES[dept]}
                        </div>
                        <span class="dept-status-badge ${data.status}">${data.status}</span>
                    </div>
                    <div class="dept-stats">
                        <div>
                            <div class="dept-stat-value">${tasks.filter(t => t.dept === dept).length}</div>
                            <div class="dept-stat-label">Tasks</div>
                        </div>
                        <div>
                            <div class="dept-stat-value">${Math.round(tasks.filter(t => t.dept === dept).reduce((sum, t) => sum + t.progress, 0) / Math.max(tasks.filter(t => t.dept === dept).length, 1))}%</div>
                            <div class="dept-stat-label">Progress</div>
                        </div>
                        <div>
                            <div class="dept-stat-value">${tasks.filter(t => t.dept === dept && t.status === 'blocked').length}</div>
                            <div class="dept-stat-label">Blocked</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ============ DRAG & DROP ============
        function setupDragAndDrop() {
            const cards = document.querySelectorAll('.task-card');
            const containers = document.querySelectorAll('.tasks-container');
            
            cards.forEach(card => {
                card.addEventListener('dragstart', () => card.classList.add('dragging'));
                card.addEventListener('dragend', () => card.classList.remove('dragging'));
            });
            
            containers.forEach(container => {
                container.addEventListener('dragover', e => {
                    e.preventDefault();
                    const dragging = document.querySelector('.dragging');
                    if (dragging) container.appendChild(dragging);
                });
                
                container.addEventListener('drop', e => {
                    e.preventDefault();
                    const dragging = document.querySelector('.dragging');
                    if (!dragging) return;
                    
                    const taskId = parseInt(dragging.dataset.taskId);
                    const newStatus = container.dataset.status;
                    const task = tasks.find(t => t.id === taskId);
                    
                    if (task && task.status !== newStatus) {
                        task.status = newStatus;
                        if (newStatus === 'done') task.progress = 100;
                        renderTasks();
                        renderDeptStatus();
                    }
                });
            });
        }

        // ============ TASK CRUD ============
        function openAddTaskModal() {
            document.getElementById('addTaskModal').classList.add('active');
        }

        function closeAddTaskModal() {
            document.getElementById('addTaskModal').classList.remove('active');
            document.getElementById('addTaskForm').reset();
        }

        function addTask(event) {
            event.preventDefault();
            
            const newTask = {
                id: Date.now(),
                title: document.getElementById('taskTitle').value,
                dept: document.getElementById('taskDept').value,
                status: document.getElementById('taskStatus').value,
                progress: parseInt(document.getElementById('taskProgress').value) || 0,
                time: document.getElementById('taskTime').value,
                due: document.getElementById('taskDue').value,
                blocker: document.getElementById('taskBlocker').value
            };
            
            tasks.push(newTask);
            renderTasks();
            renderDeptStatus();
            closeAddTaskModal();
        }

        function saveTasks() {
            localStorage.setItem('kanban-tasks', JSON.stringify(tasks));
        }

        function filterTasks() {
            renderTasks();
        }

        // ============ UTILITIES ============
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function refreshDashboard() {
            renderTasks();
            renderDeptStatus();
        }

        // Modal close on outside click
        document.getElementById('addTaskModal').addEventListener('click', e => {
            if (e.target.id === 'addTaskModal') closeAddTaskModal();
        });

        // ============ AUTH ============
        const AUTH_PASSWORD = 'pepper';
        const AUTH_CODE = '2222';
        let keypadCode = '';
        
        function checkAuth() {
            const auth = sessionStorage.getItem('pepper-auth');
            if (auth === 'full') {
                // Fully authenticated
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('keypadOverlay').classList.add('hidden');
            } else if (auth === 'password') {
                // Password done, need keypad
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('keypadOverlay').classList.remove('hidden');
            } else {
                // Need password
                document.getElementById('loginOverlay').classList.remove('hidden');
                document.getElementById('keypadOverlay').classList.add('hidden');
            }
        }
        
        function checkPassword() {
            const pwd = document.getElementById('loginPassword').value;
            if (pwd === AUTH_PASSWORD) {
                sessionStorage.setItem('pepper-auth', 'password');
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('keypadOverlay').classList.remove('hidden');
                document.getElementById('loginPassword').value = '';
            } else {
                document.getElementById('loginError').textContent = 'Incorrect password';
                setTimeout(() => document.getElementById('loginError').textContent = '', 2000);
            }
        }
        
        function addKey(digit) {
            console.log('Key pressed:', digit, 'Current code:', keypadCode);
            if (keypadCode.length < 4) {
                keypadCode += digit;
                updateKeypadDisplay();
                
                if (keypadCode.length === 4) {
                    submitKeys();
                }
            }
        }
        
        function clearKeys() {
            keypadCode = '';
            updateKeypadDisplay();
            document.getElementById('keypadError').textContent = '';
        }
        
        function updateKeypadDisplay() {
            const display = document.getElementById('keypadDisplay');
            if (display) {
                const filled = '‚óè'.repeat(keypadCode.length);
                const empty = '‚óã'.repeat(4 - keypadCode.length);
                display.textContent = filled + empty;
            }
        }
        
        function submitKeys() {
            console.log('Submitting code:', keypadCode, 'Expected:', AUTH_CODE);
            if (keypadCode === AUTH_CODE) {
                sessionStorage.setItem('pepper-auth', 'full');
                document.getElementById('keypadOverlay').classList.add('hidden');
                keypadCode = ''; // Reset for next time
            } else {
                document.getElementById('keypadError').textContent = 'Invalid code';
                keypadCode = '';
                updateKeypadDisplay();
                setTimeout(() => {
                    const err = document.getElementById('keypadError');
                    if (err) err.textContent = '';
                }, 2000);
            }
        }
        
        // Check auth on load
        checkAuth();
        
        // Usage tracking
        async function refreshUsage() {
            try {
                const res = await fetch('/api/usage');
                const data = await res.json();
                
                if (data.services) {
                    const container = document.getElementById('usageCards');
                    container.innerHTML = data.services.map(s => {
                        let fillClass = '';
                        if (s.percent > 80) fillClass = 'danger';
                        else if (s.percent > 50) fillClass = 'warning';
                        
                        const barHtml = s.percent !== null 
                            ? `<div class="usage-bar"><div class="usage-fill ${fillClass}" style="width:${s.percent}%"></div></div>`
                            : '';
                        
                        const textHtml = s.percent !== null
                            ? `${s.used?.toLocaleString() || 0} / ${s.limit?.toLocaleString() || '‚àû'} (${s.percent}%)`
                            : (s.note || s.plan);
                        
                        return `
                            <div class="usage-card">
                                <div class="usage-service">${s.service}</div>
                                ${barHtml}
                                <div class="usage-text">${textHtml}</div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (err) {
                console.error('Usage fetch error:', err);
            }
        }
        
        // Load usage on page load
        setTimeout(refreshUsage, 1000);
        
        // Theme toggle
        function toggleTheme() {
            const body = document.body;
            const sunIcon = document.getElementById('sunIcon');
            const moonIcon = document.getElementById('moonIcon');
            
            if (body.classList.contains('light-theme')) {
                body.classList.remove('light-theme');
                sunIcon.classList.remove('active');
                moonIcon.classList.add('active');
                localStorage.setItem('pepper-theme', 'dark');
            } else {
                body.classList.add('light-theme');
                sunIcon.classList.add('active');
                moonIcon.classList.remove('active');
                localStorage.setItem('pepper-theme', 'light');
            }
        }
        
        // Load saved theme
        if (localStorage.getItem('pepper-theme') === 'light') {
            document.body.classList.add('light-theme');
            document.getElementById('sunIcon').classList.add('active');
            document.getElementById('moonIcon').classList.remove('active');
        }
        
        function toggleMenu() {
            // TODO: Add slide-out menu
            console.log('Menu clicked');
        }
        
        function toggleNotifications() {
            // TODO: Show notifications panel  
            console.log('Notifications clicked');
        }

        // ============ INIT ============
        updateClock();
        setInterval(updateClock, 1000);
        renderTasks();
        renderDeptStatus();
    </script>

    <!-- Floating Chat Button & Widget -->
    <style>
        .chat-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e82127, #c91c21);
            border: none;
            box-shadow: 0 4px 20px rgba(232, 33, 39, 0.4);
            cursor: pointer;
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            transition: all 0.3s ease;
        }
        .chat-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 28px rgba(232, 33, 39, 0.5);
        }
        .chat-fab.hidden { display: none; }

        .chat-widget {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 340px;
            height: 480px;
            background: #141414;
            border: 1px solid #333;
            border-radius: 20px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.5);
            z-index: 9999;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        .chat-widget.open { display: flex; }

        @media (max-width: 480px) {
            .chat-widget {
                width: calc(100% - 20px);
                height: calc(100% - 100px);
                bottom: 10px;
                right: 10px;
                border-radius: 16px;
            }
            .chat-fab {
                bottom: 16px;
                right: 16px;
            }
        }

        .chat-widget-header {
            background: linear-gradient(135deg, #e82127, #c91c21);
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        .chat-widget-header h3 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chat-widget-header .online-dot {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse-online 2s infinite;
        }
        @keyframes pulse-online {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .close-chat-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .close-chat-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .chat-widget-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .chat-msg {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 16px;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .chat-msg.assistant {
            background: #252525;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .chat-msg.user {
            background: linear-gradient(135deg, #e82127, #c91c21);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .chat-widget-input {
            padding: 12px 16px;
            border-top: 1px solid #333;
            display: flex;
            gap: 10px;
        }
        .chat-widget-input input {
            flex: 1;
            padding: 12px 16px;
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 24px;
            color: white;
            font-size: 0.9rem;
            outline: none;
        }
        .chat-widget-input input:focus {
            border-color: #e82127;
        }
        .chat-widget-input input::placeholder {
            color: #666;
        }
        .chat-send-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e82127, #c91c21);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chat-send-btn:hover {
            opacity: 0.9;
        }
        .voice-btn {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            padding: 4px 8px;
            font-size: 0.8rem;
            margin-left: 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .voice-btn:hover {
            background: rgba(232,33,39,0.2);
            color: #e82127;
        }
        .voice-btn.playing {
            color: #e82127;
            animation: pulse-voice 1s infinite;
        }
        @keyframes pulse-voice {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .voice-call-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #252525;
            border: 2px solid #444;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .voice-call-btn:hover {
            border-color: #e82127;
        }
        .attach-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #252525;
            border: 2px solid #444;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .attach-btn:hover {
            border-color: #e82127;
        }
        .play-voice-btn {
            background: #e82127;
            border: none;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            cursor: pointer;
            margin-left: 8px;
        }
        .play-voice-btn:hover {
            background: #c91c21;
        }
        .voice-call-btn.active {
            background: linear-gradient(135deg, #e82127, #c91c21);
            border-color: #e82127;
            animation: pulse-mic 1.5s infinite;
        }
        @keyframes pulse-mic {
            0%, 100% { box-shadow: 0 0 0 0 rgba(232,33,39,0.4); }
            50% { box-shadow: 0 0 0 12px rgba(232,33,39,0); }
        }
        .voice-status {
            display: none;
            padding: 8px 16px;
            background: rgba(232,33,39,0.1);
            border-top: 1px solid rgba(232,33,39,0.2);
            font-size: 0.8rem;
            color: #e82127;
            text-align: center;
        }
        .voice-status.active {
            display: block;
        }
        
        /* Usage Section */
        .usage-section {
            background: var(--bg-secondary, #141414);
            border: 1px solid var(--border-color, #2a2a2a);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .usage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            font-weight: 600;
        }
        .usage-cards {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .usage-card {
            flex: 1;
            min-width: 150px;
            background: rgba(255,255,255,0.03);
            padding: 0.75rem;
            border-radius: 8px;
        }
        .usage-service {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 0.5rem;
        }
        .usage-bar {
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.4rem;
        }
        .usage-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #22c55e);
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        .usage-fill.warning { background: linear-gradient(90deg, #fbbf24, #f59e0b); }
        .usage-fill.danger { background: linear-gradient(90deg, #ef4444, #dc2626); }
        .usage-text {
            font-size: 0.75rem;
            color: #666;
        }
        body.light-theme .usage-section {
            background: #fff;
            border-color: #e0e0e0;
        }
        body.light-theme .usage-card {
            background: #f5f5f5;
        }
        
        /* Clean Header Styles */
        .menu-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.4rem;
            cursor: pointer;
            padding: 8px;
            margin-right: 8px;
        }
        .menu-btn:hover {
            opacity: 0.8;
        }
        .branding h1 {
            font-size: 1.3rem !important;
            font-weight: 600;
        }
        .branding .subtitle {
            display: none;
        }
        .theme-toggle {
            display: flex;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 4px;
            gap: 4px;
            cursor: pointer;
        }
        .theme-icon {
            padding: 6px 10px;
            border-radius: 16px;
            font-size: 1rem;
            opacity: 0.5;
            transition: all 0.2s;
        }
        .theme-icon.active {
            background: rgba(255,255,255,0.2);
            opacity: 1;
        }
        .icon-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 8px;
        }
        .icon-btn:hover {
            opacity: 0.8;
        }
        
        /* Light theme - EVERYTHING light */
        body.light-theme {
            --bg-primary: #f0f2f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e4e6eb;
            --bg-card: #ffffff;
            --bg-hover: #f5f5f5;
            --text-primary: #1a1a1a;
            --text-secondary: #666;
            --text-muted: #999;
            --border-color: #e0e0e0;
            --border-light: #eee;
        }
        body.light-theme {
            background: var(--bg-primary) !important;
        }
        body.light-theme .header {
            background: #fff !important;
            border-bottom: 1px solid #e0e0e0;
        }
        body.light-theme .menu-btn,
        body.light-theme .icon-btn {
            color: #333;
        }
        body.light-theme .branding h1 {
            color: #333;
        }
        body.light-theme .theme-toggle {
            background: rgba(0,0,0,0.08);
        }
        body.light-theme .clock {
            color: #666;
        }
        body.light-theme .container {
            background: var(--bg-primary);
        }
        body.light-theme .blockers-section {
            background: #fff3f3 !important;
            border-color: #ffcdd2 !important;
        }
        body.light-theme .summary-card {
            background: #fff !important;
            border: 1px solid #e0e0e0 !important;
            color: #333 !important;
        }
        body.light-theme .summary-card .label {
            color: #666 !important;
        }
        body.light-theme .summary-card .value {
            color: #1a1a1a !important;
        }
        body.light-theme .section-header h2 {
            color: #333 !important;
        }
        body.light-theme .kanban-column {
            background: #f8f9fa !important;
            border: 1px solid #e0e0e0 !important;
        }
        body.light-theme .column-header {
            background: #f0f2f5 !important;
            color: #333 !important;
            border-bottom: 1px solid #e0e0e0 !important;
        }
        body.light-theme .task-card {
            background: #fff !important;
            border: 1px solid #e0e0e0 !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08) !important;
        }
        body.light-theme .task-title {
            color: #1a1a1a !important;
        }
        body.light-theme .task-meta {
            color: #666 !important;
        }
        body.light-theme .dept-card {
            background: #fff !important;
            border: 1px solid #e0e0e0 !important;
        }
        body.light-theme .dept-name {
            color: #333 !important;
        }
        body.light-theme .progress-bar {
            background: #e0e0e0 !important;
        }
        body.light-theme .chat-widget {
            background: #fff !important;
            border: 1px solid #e0e0e0 !important;
        }
        body.light-theme .chat-widget-messages {
            background: #fafafa !important;
        }
        body.light-theme .chat-msg.assistant {
            background: #f0f2f5 !important;
            color: #333 !important;
        }
        body.light-theme .chat-widget-input {
            background: #fff !important;
            border-top: 1px solid #e0e0e0 !important;
        }
        body.light-theme .chat-widget-input input {
            background: #f5f5f5 !important;
            border: 1px solid #e0e0e0 !important;
            color: #333 !important;
        }
        body.light-theme .chat-fab {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }
    </style>

    <!-- Chat FAB -->
    <!-- Product Views (hidden by default) -->
    <div id="view-bloom" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9000; background: #0a0a0a;">
        <div style="padding: 1rem; background: #1a1a2e; display: flex; align-items: center; gap: 1rem;">
            <button onclick="showView('dashboard')" style="padding: 0.5rem 1rem; background: linear-gradient(135deg, #f687b3, #f6ad55); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600;">‚Üê Back to Dashboard</button>
            <span style="color: #f687b3; font-size: 1.2rem; font-weight: 600;">üå∏ BLOOM Proposal System</span>
        </div>
        <iframe src="live/bloom.html" style="width: 100%; height: calc(100% - 60px); border: none;"></iframe>
    </div>

    <div id="view-nectar" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9000; background: #0a0a0a;">
        <div style="padding: 1rem; background: #1a1a2e; display: flex; align-items: center; gap: 1rem;">
            <button onclick="showView('dashboard')" style="padding: 0.5rem 1rem; background: linear-gradient(135deg, #f6ad55, #ed8936); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600;">‚Üê Back to Dashboard</button>
            <span style="color: #f6ad55; font-size: 1.2rem; font-weight: 600;">üçØ NECTAR CRM</span>
        </div>
        <iframe src="live/nectar.html" style="width: 100%; height: calc(100% - 60px); border: none;"></iframe>
    </div>

    <div id="view-atlas" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9000; background: #0a0a0a;">
        <div style="padding: 1rem; background: #1a1a2e; display: flex; align-items: center; gap: 1rem;">
            <button onclick="showView('dashboard')" style="padding: 0.5rem 1rem; background: linear-gradient(135deg, #667eea, #764ba2); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600;">‚Üê Back to Dashboard</button>
            <span style="color: #667eea; font-size: 1.2rem; font-weight: 600;">‚ö° ATLAS AI Employee</span>
        </div>
        <iframe src="live/atlas.html" style="width: 100%; height: calc(100% - 60px); border: none;"></iframe>
    </div>

    <button class="chat-fab" id="chatFab" onclick="openChat()">üå∂Ô∏è</button>

    <!-- Chat Widget -->
    <div class="chat-widget" id="chatWidget">
        <div class="chat-widget-header">
            <h3><span class="online-dot"></span> Chat with Pepper</h3>
            <button class="close-chat-btn" onclick="closeChat()">‚úï</button>
        </div>
        <div class="chat-widget-messages" id="chatMessages">
            <div class="chat-msg assistant">Hey Joey! üå∂Ô∏è What do you need?</div>
        </div>
        <div class="chat-widget-input">
            <button class="voice-call-btn" id="voiceCallBtn" onclick="callPepper()" title="Call Pepper">üìû</button>
            <button class="voice-call-btn" id="micBtn" onclick="toggleVoiceCall()" title="Voice Chat">üéôÔ∏è</button>
            <label class="attach-btn" for="fileInput">üìé</label>
            <input type="file" id="fileInput" style="display:none" onchange="handleAttachment(this)" accept="image/*,.pdf,.doc,.docx,.txt">
            <input type="text" id="chatInput" placeholder="Type, mic, or call..." onkeypress="if(event.key==='Enter')sendChat()">
            <button class="chat-send-btn" onclick="sendChat()">‚û§</button>
        </div>
        <div class="voice-status" id="voiceStatus"></div>
    </div>

    <script>
        let chatHistory = [];
        
        function openChat() {
            document.getElementById('chatFab').classList.add('hidden');
            document.getElementById('chatWidget').classList.add('open');
            setTimeout(() => document.getElementById('chatInput').focus(), 100);
        }
        
        function closeChat() {
            document.getElementById('chatWidget').classList.remove('open');
            document.getElementById('chatFab').classList.remove('hidden');
        }
        
        async function sendChat() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;

            const msgsDiv = document.getElementById('chatMessages');
            
            // Add user message
            msgsDiv.innerHTML += `<div class="chat-msg user">${escapeHtml(msg)}</div>`;
            input.value = '';
            input.disabled = true;
            msgsDiv.scrollTop = msgsDiv.scrollHeight;
            
            // Show typing indicator
            const typingId = 'typing-' + Date.now();
            msgsDiv.innerHTML += `<div class="chat-msg assistant" id="${typingId}" style="opacity:0.6">Thinking...</div>`;
            msgsDiv.scrollTop = msgsDiv.scrollHeight;

            try {
                // Call the API
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: msg,
                        history: chatHistory.slice(-10) // Last 10 messages for context
                    })
                });
                
                const data = await response.json();
                
                // Remove typing indicator
                document.getElementById(typingId)?.remove();
                
                if (data.error) {
                    msgsDiv.innerHTML += `<div class="chat-msg assistant" style="color:#e82127">Error: ${escapeHtml(data.error)}</div>`;
                } else {
                    // Add to history
                    chatHistory.push({ role: 'user', content: msg });
                    chatHistory.push({ role: 'assistant', content: data.response });
                    
                    // Display response with voice button
                    const msgId = 'msg-' + Date.now();
                    msgsDiv.innerHTML += `<div class="chat-msg assistant" id="${msgId}">${formatResponse(data.response)}<button class="voice-btn" onclick="playVoice('${msgId}', \`${escapeForAttr(data.response)}\`)">üîä</button></div>`;
                }
            } catch (err) {
                document.getElementById(typingId)?.remove();
                msgsDiv.innerHTML += `<div class="chat-msg assistant" style="color:#e82127">Connection error. Try again.</div>`;
            }
            
            input.disabled = false;
            input.focus();
            msgsDiv.scrollTop = msgsDiv.scrollHeight;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatResponse(text) {
            // Basic markdown-like formatting
            return escapeHtml(text)
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
        }
        
        function escapeForAttr(text) {
            return text.replace(/`/g, '\\`').replace(/\$/g, '\\$').replace(/'/g, "\\'");
        }
        
        let currentAudio = null;
        let voiceCallActive = false;
        let recognition = null;
        
        function toggleVoiceCall() {
            if (voiceCallActive) {
                stopVoiceCall();
            } else {
                startVoiceCall();
            }
        }
        
        function startVoiceCall() {
            const status = document.getElementById('voiceStatus');
            const btn = document.getElementById('micBtn');
            
            // Check for speech recognition support
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                status.classList.add('active');
                status.textContent = '‚ùå Voice not supported - use Chrome';
                status.style.color = '#e82127';
                setTimeout(() => {
                    status.classList.remove('active');
                    status.style.color = '';
                }, 3000);
                return;
            }
            
            // Show starting status
            status.classList.add('active');
            status.textContent = 'üéôÔ∏è Starting mic...';
            if (btn) btn.classList.add('active');
            
            // Unlock audio for iOS on user interaction
            if (audioPlayer) {
                audioPlayer.src = "data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA";
                audioPlayer.play().catch(() => {});
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            
            const btn = document.getElementById('micBtn');
            const status = document.getElementById('voiceStatus');
            const input = document.getElementById('chatInput');
            
            if (btn) btn.classList.add('active');
            status.classList.add('active');
            status.textContent = 'üéôÔ∏è Listening...';
            voiceCallActive = true;
            
            let finalTranscript = '';
            let silenceTimer = null;
            
            recognition.onresult = (event) => {
                let interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                // Show what's being said
                input.value = finalTranscript + interimTranscript;
                status.textContent = 'üéôÔ∏è ' + (interimTranscript || 'Listening...');
                
                // Reset silence timer
                clearTimeout(silenceTimer);
                
                // If we have a final transcript, wait for SHORT silence then send
                if (finalTranscript.trim()) {
                    silenceTimer = setTimeout(() => {
                        if (finalTranscript.trim() && voiceCallActive) {
                            // Send the message
                            input.value = finalTranscript.trim();
                            sendChatWithVoice();
                            finalTranscript = '';
                        }
                    }, 800); // 0.8 seconds = faster response
                }
            };
            
            recognition.onerror = (event) => {
                console.error('Speech error:', event.error);
                const errorMessages = {
                    'not-allowed': '‚ùå Mic access denied - check permissions',
                    'no-speech': 'üîá No speech detected - try again',
                    'audio-capture': '‚ùå No microphone found',
                    'network': '‚ùå Network error',
                    'aborted': '‚èπÔ∏è Stopped',
                    'service-not-allowed': '‚ùå Speech service not allowed'
                };
                status.textContent = errorMessages[event.error] || `‚ùå Error: ${event.error}`;
                if (event.error === 'not-allowed' || event.error === 'audio-capture') {
                    setTimeout(stopVoiceCall, 3000);
                }
            };
            
            recognition.onend = () => {
                // Restart if still active
                if (voiceCallActive) {
                    try {
                        recognition.start();
                    } catch (e) {
                        console.log('Recognition restart failed');
                    }
                }
            };
            
            recognition.start();
        }
        
        function stopVoiceCall() {
            voiceCallActive = false;
            
            if (recognition) {
                recognition.stop();
                recognition = null;
            }
            
            document.getElementById('micBtn')?.classList.remove('active');
            document.getElementById('voiceStatus').classList.remove('active');
            document.getElementById('chatInput').value = '';
            
            // Stop any playing audio
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
        }
        
        async function sendChatWithVoice() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;

            const msgsDiv = document.getElementById('chatMessages');
            const status = document.getElementById('voiceStatus');
            
            // Add user message
            msgsDiv.innerHTML += `<div class="chat-msg user">${escapeHtml(msg)}</div>`;
            input.value = '';
            msgsDiv.scrollTop = msgsDiv.scrollHeight;
            
            status.textContent = 'üí≠ Pepper is thinking...';

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: msg,
                        history: chatHistory.slice(-10)
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    msgsDiv.innerHTML += `<div class="chat-msg assistant" style="color:#e82127">Error: ${escapeHtml(data.error)}</div>`;
                    status.textContent = 'üéôÔ∏è Listening...';
                    return;
                }
                
                // Add to history
                chatHistory.push({ role: 'user', content: msg });
                chatHistory.push({ role: 'assistant', content: data.response });
                
                // Display response
                const msgId = 'msg-' + Date.now();
                const responseText = data.response;
                msgsDiv.innerHTML += `<div class="chat-msg assistant" id="${msgId}">${formatResponse(responseText)}</div>`;
                msgsDiv.scrollTop = msgsDiv.scrollHeight;
                
                // Auto-speak the response using native browser speech
                speakResponse(responseText);
                
            } catch (err) {
                msgsDiv.innerHTML += `<div class="chat-msg assistant" style="color:#e82127">Connection error</div>`;
                status.textContent = 'üéôÔ∏è Listening...';
            }
        }
        
        // Audio player element (more reliable on iOS)
        let audioPlayer = null;
        
        // Create audio player on page load
        function initAudioPlayer() {
            audioPlayer = document.createElement('audio');
            audioPlayer.id = 'pepperVoice';
            audioPlayer.setAttribute('playsinline', '');
            audioPlayer.setAttribute('webkit-playsinline', '');
            document.body.appendChild(audioPlayer);
        }
        initAudioPlayer();
        
        async function speakResponse(text) {
            const status = document.getElementById('voiceStatus');
            status.textContent = 'üîä Pepper speaking...';
            
            // Use browser's native speech synthesis
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 1.0;
                utterance.pitch = 1.1;
                utterance.volume = 1.0;
                
                // Try to get a female voice
                const voices = window.speechSynthesis.getVoices();
                const femaleVoice = voices.find(v => 
                    v.name.includes('Samantha') || 
                    v.name.includes('Karen') || 
                    v.name.includes('Female') ||
                    v.name.includes('Google US English')
                );
                if (femaleVoice) {
                    utterance.voice = femaleVoice;
                }
                
                utterance.onend = () => {
                    status.textContent = voiceCallActive ? 'üéôÔ∏è Listening...' : '';
                };
                
                utterance.onerror = (e) => {
                    console.error('Speech error:', e);
                    status.textContent = voiceCallActive ? 'üéôÔ∏è Listening...' : '';
                };
                
                window.speechSynthesis.speak(utterance);
            } else {
                status.textContent = voiceCallActive ? 'üéôÔ∏è Listening...' : '';
            }
        }
        
        // ElevenLabs Phone Call - Direct to Pepper
        const PEPPER_PHONE = '9709720417';
        
        function callPepper() {
            // Opens phone dialer to call Pepper directly
            window.location.href = 'tel:' + PEPPER_PHONE;
        }
        
        // Manual play button (bypasses autoplay restrictions)
        async function playThisMessage(msgId, text) {
            const btn = document.querySelector(`#${msgId} .play-voice-btn`);
            if (btn) btn.textContent = '‚è≥ Loading...';
            
            try {
                const response = await fetch('/api/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text.substring(0, 300) })
                });
                
                if (!response.ok) {
                    if (btn) btn.textContent = '‚ùå Error';
                    return;
                }
                
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                
                const audio = new Audio(audioUrl);
                audio.onended = () => {
                    URL.revokeObjectURL(audioUrl);
                    if (btn) btn.textContent = 'üîä Play';
                };
                
                if (btn) btn.textContent = 'üîä Playing...';
                await audio.play();
                
            } catch (err) {
                console.error('Play error:', err);
                if (btn) btn.textContent = '‚ùå Error';
            }
        }
        
        // Attachment handler
        function handleAttachment(input) {
            const file = input.files[0];
            if (!file) return;
            
            const msgsDiv = document.getElementById('chatMessages');
            
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    msgsDiv.innerHTML += `<div class="chat-msg user"><img src="${e.target.result}" style="max-width:200px;border-radius:8px;"></div>`;
                    msgsDiv.scrollTop = msgsDiv.scrollHeight;
                };
                reader.readAsDataURL(file);
            } else {
                msgsDiv.innerHTML += `<div class="chat-msg user">üìé ${file.name}</div>`;
                msgsDiv.scrollTop = msgsDiv.scrollHeight;
            }
            
            // Clear input for next upload
            input.value = '';
        }
        
        async function playVoice(msgId, text) {
            const btn = document.querySelector(`#${msgId} .voice-btn`);
            
            // Stop if already playing
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
                document.querySelectorAll('.voice-btn').forEach(b => b.classList.remove('playing'));
                return;
            }
            
            btn.classList.add('playing');
            btn.textContent = '‚èπÔ∏è';
            
            try {
                const response = await fetch('/api/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text.substring(0, 500) }) // Limit text length
                });
                
                if (!response.ok) throw new Error('TTS failed');
                
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                
                currentAudio = new Audio(audioUrl);
                currentAudio.onended = () => {
                    btn.classList.remove('playing');
                    btn.textContent = 'üîä';
                    currentAudio = null;
                };
                currentAudio.play();
                
            } catch (err) {
                console.error('Voice error:', err);
                btn.classList.remove('playing');
                btn.textContent = 'üîä';
            }
        }
    </script>
</body>
</html>
